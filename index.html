<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Schedule Appointment Bot</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 720px; margin: 24px auto; }
    #chat { height: 420px; overflow:auto; border:1px solid #ccc; padding: 12px; border-radius: 8px; }
    .msg { margin: 10px 0; }
    .you { color: #9ad; }
    .bot { color: #ad9; white-space: pre-wrap; }
    .row { display:flex; gap: 8px; margin-top: 10px; }
    input { flex:1; padding: 10px; border-radius: 8px; border: 1px solid #444; }
    button { padding: 10px 14px; border-radius: 8px; border: 1px solid #444; cursor: pointer; }
  </style>
</head>

<body>
  <h2>Lex Appointment Chatbot</h2>
  <div id="chat"></div>

  <div class="row">
    <input id="msg" placeholder="Type a message..." />
    <button id="sendBtn">Send</button>
  </div>

  <script type="module">
    import { CognitoIdentityClient } from "https://cdn.skypack.dev/@aws-sdk/client-cognito-identity";
    import { fromCognitoIdentityPool } from "https://cdn.skypack.dev/@aws-sdk/credential-provider-cognito-identity";
    import { LexRuntimeV2Client, RecognizeTextCommand } from "https://cdn.skypack.dev/@aws-sdk/client-lex-runtime-v2";

    // ===================== CONFIG (EDIT THESE) =====================
    const REGION = "us-east-1"; // must match Lex bot region
    const IDENTITY_POOL_ID = "us-east-1:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx";
    const BOT_ID = "XXXXXXXXXX";
    const BOT_ALIAS_ID = "YYYYYYYYYY";
    const LOCALE_ID = "en_US";
    // ===============================================================

    const chat = document.getElementById("chat");
    const input = document.getElementById("msg");
    const sendBtn = document.getElementById("sendBtn");

    function addMsg(who, text) {
      const div = document.createElement("div");
      div.className = "msg " + (who === "You" ? "you" : "bot");
      div.innerHTML = `<b>${who}:</b> ${escapeHtml(text)}`;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    function escapeHtml(s) {
      return s.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
    }

    const lexClient = new LexRuntimeV2Client({
      region: REGION,
      credentials: fromCognitoIdentityPool({
        client: new CognitoIdentityClient({ region: REGION }),
        identityPoolId: IDENTITY_POOL_ID,
      }),
    });

    const SESSION_ID = "web-" + Math.random().toString(36).slice(2);

    async function sendToLex(text) {
      const cmd = new RecognizeTextCommand({
        botId: BOT_ID,
        botAliasId: BOT_ALIAS_ID,
        localeId: LOCALE_ID,
        sessionId: SESSION_ID,
        text,
      });

      const res = await lexClient.send(cmd);

      if (res.messages && res.messages.length > 0) {
        return res.messages.map(m => m.content).join("\n");
      }
      return "(No response from bot)";
    }

    async function onSend() {
      const userText = input.value.trim();
      if (!userText) return;

      input.value = "";
      addMsg("You", userText);

      try {
        const reply = await sendToLex(userText);
        addMsg("Bot", reply);
      } catch (err) {
        console.error(err);
        addMsg("Bot", "Error calling Lex. Check:\n- REGION\n- BotId/BotAliasId\n- Cognito role permissions (lex:RecognizeText)");
      }
    }

    sendBtn.addEventListener("click", onSend);
    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter") onSend();
    });

    addMsg("Bot", "Hi! Say: “I would like to make an appointment”.");
  </script>
</body>
</html>
